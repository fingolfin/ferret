#!/bin/sh
# usage: configure gappath
# this script creates a `Makefile' from `Makefile.in'
if test -z $1; then
  GAPPATH=$(cd ../..; pwd); echo "Using ../.. as default GAP path";
else
  GAPPATH=$1;
fi

if ! test -e $GAPPATH/sysinfo.gap; then
  echo "Please give correct GAP path as argument (and make sure that GAP"
  echo "is already properly installed)."
  echo "Building without GAP support"
  c_compiler=cc
  buildlist="symmetry_detect"
else
    . $GAPPATH/sysinfo.gap

    echo "Architecture is $GAParch (from sysinfo.gap)"

    GAPARCH=$GAPPATH/bin/$GAParch

    . $GAPARCH/sysinfo.gap

    echo "C compiler is $c_compiler (from $GAParch/sysinfo.gap)"

    buildlist="library symmetry_detect"
fi


DEBUGFLAGS=

# This debugging is broken on macs
if [ $(uname -s) = Linux ]; then
	DEBUGFLAGS="${DEBUGFLAGS} -D_GLIBCXX_DEBUG"
fi

# Let's find a C++ standard library. In practice there are two.

func_get_libname () {
  for flag in -lstdc++ -llibc++; do
    if echo "#include <vector>\n#include<string.h>\n#include<string>\n int main(void) { std::vector<int> v(5); }" | $c_compiler $flag -x c++  -c - -o /dev/null 1>/dev/null 2>/dev/null; then
        CPPLIB="$flag"
        return 0
    fi
  done
  echo "Cannot find working C++ standard library".
  exit 1
}

func_get_libname

# See if valgrind exists

VALGRIND="valgrind -q"
$VALGRIND --help 1>/dev/null 2>/dev/null || VALGRIND=


sed -e "s|@GAPARCH@|$GAParch|g" \
    -e "s|@BUILDLIST@|$buildlist|g" \
    -e "s|@DEBUGFLAGS@|$DEBUGFLAGS|g" \
    -e "s|@VALGRIND@|$VALGRIND|g" \
    -e "s|@GAPPATH@|$GAPPATH|g" \
    -e "s|@CPPLIB@|$CPPLIB|g" \
      Makefile.in > Makefile
echo "Makefile successfully created."

echo '#!/bin/bash' > ferret.vars
echo export GAPARCH=\"$GAParch\" >> ferret.vars
echo export CC=$c_compiler >> ferret.vars
echo export VALGRIND=\"$VALGRIND\" >> ferret.vars
echo export DEBUGFLAGS=\"$DEBUGFLAGS\" >> ferret.vars
echo export GAPPATH=\"$GAPPATH\" >> ferret.vars
echo export GAPEXEC=\"$GAPPATH/bin/gap.sh -b\" >> ferret.vars
echo export CPPLIB=\"$CPPLIB\" >> ferret.vars
